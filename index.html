<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Pool Service</title>
    <script src="sw.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .api-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        .endpoint {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .method {
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .get { background: #28a745; }
        .post { background: #007bff; }
        .put { background: #ffc107; color: #333; }
        .delete { background: #dc3545; }
        .test-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .config-section {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .config-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ API Key Pool Service</h1>
        
        <div class="config-section">
            <h3>âš™ï¸ é…ç½®ä¿¡æ¯</h3>
            <div>
                <label>æœåŠ¡åœ°å€:</label>
                <input type="text" id="serviceUrl" class="config-input" 
                       value="https://your-username.github.io/api-key-pool-service" 
                       placeholder="è¾“å…¥ä½ çš„GitHub Pagesåœ°å€">
            </div>
            <div>
                <label>ç®¡ç†å‘˜å¯†é’¥:</label>
                <input type="password" id="adminKey" class="config-input" 
                       placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†é’¥">
            </div>
            <div>
                <label>Gemini APIå¯†é’¥:</label>
                <input type="password" id="geminiApiKey" class="config-input" 
                       placeholder="è¾“å…¥Gemini APIå¯†é’¥">
            </div>
            <div>
                <label>ä¸­è½¬æœåŠ¡åœ°å€:</label>
                <input type="text" id="proxyUrl" class="config-input" 
                       value="https://steamgovernment.deno.dev" 
                       placeholder="è¾“å…¥ä¸­è½¬æœåŠ¡åœ°å€">
            </div>
            <div>
                <label>
                    <input type="checkbox" id="enableProxy" checked> å¯ç”¨ä¸­è½¬æœåŠ¡
                </label>
            </div>
            <div>
                <label>
                    <input type="checkbox" id="fallbackDirect" checked> ä¸­è½¬å¤±è´¥æ—¶å›é€€åˆ°ç›´æ¥è°ƒç”¨
                </label>
            </div>
            <button class="test-button" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
        </div>

        <div class="api-section">
            <h3>ğŸ“š API ç«¯ç‚¹</h3>
            
            <div class="endpoint">
                <span class="method get">GET</span> /health - å¥åº·æ£€æŸ¥
            </div>
            
            <div class="endpoint">
                <span class="method post">POST</span> /admin/keys - æ·»åŠ APIå¯†é’¥
            </div>
            
            <div class="endpoint">
                <span class="method get">GET</span> /admin/status - æŸ¥çœ‹å¯†é’¥æ± çŠ¶æ€
            </div>
            
            <div class="endpoint">
                <span class="method post">POST</span> /api/gemini/* - è°ƒç”¨Gemini API
            </div>
            
            <div class="endpoint">
                <span class="method post">POST</span> /api/openai/* - è°ƒç”¨OpenAI API
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª å¿«é€Ÿæµ‹è¯•</h3>
            <button class="test-button" onclick="testHealth()">å¥åº·æ£€æŸ¥</button>
            <button class="test-button" onclick="testAddKey()">æ·»åŠ å¯†é’¥</button>
            <button class="test-button" onclick="testGetStatus()">æŸ¥çœ‹çŠ¶æ€</button>
            <button class="test-button" onclick="testGeminiAPI()">æµ‹è¯•Gemini API</button>
            <button class="test-button" onclick="updateProxyConfig()">æ›´æ–°ä¸­è½¬é…ç½®</button>
            <button class="test-button" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button class="test-button" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
            
            <div id="testResults"></div>
        </div>

        <div class="api-section">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <p><strong>1. éƒ¨ç½²æ­¥éª¤:</strong></p>
            <ol>
                <li>å°†ä»£ç æ¨é€åˆ°GitHubä»“åº“</li>
                <li>åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨GitHub Pages</li>
                <li>é€‰æ‹©mainåˆ†æ”¯ä½œä¸ºæº</li>
                <li>ç­‰å¾…éƒ¨ç½²å®Œæˆ</li>
            </ol>
            
            <p><strong>2. é…ç½®è¯´æ˜:</strong></p>
            <ul>
                <li>æœåŠ¡åœ°å€ï¼šä½ çš„GitHub Pagesåœ°å€</li>
                <li>ç®¡ç†å‘˜å¯†é’¥ï¼šç”¨äºç®¡ç†APIå¯†é’¥çš„å¯†é’¥</li>
                <li>Gemini APIå¯†é’¥ï¼šä½ çš„Gemini APIå¯†é’¥</li>
            </ul>
            
            <p><strong>3. ä¸­è½¬æœåŠ¡é…ç½®:</strong></p>
            <ul>
                <li>ğŸ”„ å¯ç”¨ä¸­è½¬æœåŠ¡ï¼šé€šè¿‡ä»£ç†æœåŠ¡è½¬å‘APIè¯·æ±‚</li>
                <li>ğŸ”„ å›é€€æœºåˆ¶ï¼šä¸­è½¬å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°ç›´æ¥è°ƒç”¨</li>
                <li>ğŸ”„ åŠ¨æ€é…ç½®ï¼šå¯ä»¥éšæ—¶ä¿®æ”¹ä¸­è½¬æœåŠ¡åœ°å€</li>
                <li>ğŸ”„ CORSè§£å†³ï¼šé¿å…è·¨åŸŸé—®é¢˜</li>
            </ul>
            
            <p><strong>4. ä¼˜åŠ¿:</strong></p>
            <ul>
                <li>âœ… æ— è°ƒç”¨æ¬¡æ•°é™åˆ¶</li>
                <li>âœ… å®Œå…¨å…è´¹</li>
                <li>âœ… å…¨çƒCDNåŠ é€Ÿ</li>
                <li>âœ… è‡ªåŠ¨HTTPS</li>
                <li>âœ… çµæ´»çš„ä¸­è½¬æœåŠ¡é…ç½®</li>
            </ul>
        </div>
    </div>

    <script>
        // é…ç½®ç®¡ç†
        function saveConfig() {
            const config = {
                serviceUrl: document.getElementById('serviceUrl').value,
                adminKey: document.getElementById('adminKey').value,
                geminiApiKey: document.getElementById('geminiApiKey').value,
                proxyUrl: document.getElementById('proxyUrl').value,
                enableProxy: document.getElementById('enableProxy').checked,
                fallbackDirect: document.getElementById('fallbackDirect').checked
            };
            localStorage.setItem('apiKeyPoolConfig', JSON.stringify(config));
            showResult('é…ç½®å·²ä¿å­˜', 'success');
        }

        function loadConfig() {
            const config = JSON.parse(localStorage.getItem('apiKeyPoolConfig') || '{}');
            if (config.serviceUrl) document.getElementById('serviceUrl').value = config.serviceUrl;
            if (config.adminKey) document.getElementById('adminKey').value = config.adminKey;
            if (config.geminiApiKey) document.getElementById('geminiApiKey').value = config.geminiApiKey;
            if (config.proxyUrl) document.getElementById('proxyUrl').value = config.proxyUrl;
            if (config.enableProxy !== undefined) document.getElementById('enableProxy').checked = config.enableProxy;
            if (config.fallbackDirect !== undefined) document.getElementById('fallbackDirect').checked = config.fallbackDirect;
        }

        // HTTPè¯·æ±‚å‡½æ•°
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { status: response.status, data };
            } catch (error) {
                return { status: 0, data: { error: error.message } };
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type = 'info', data = null) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            
            let content = message;
            if (data) {
                content += '\n' + JSON.stringify(data, null, 2);
            }
            
            resultDiv.textContent = content;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        // è·å–é…ç½®
        function getConfig() {
            return {
                serviceUrl: document.getElementById('serviceUrl').value,
                adminKey: document.getElementById('adminKey').value,
                geminiApiKey: document.getElementById('geminiApiKey').value,
                proxyUrl: document.getElementById('proxyUrl').value,
                enableProxy: document.getElementById('enableProxy').checked,
                fallbackDirect: document.getElementById('fallbackDirect').checked
            };
        }

        // æ›´æ–°ä¸­è½¬æœåŠ¡é…ç½®
        async function updateProxyConfig() {
            const config = getConfig();
            try {
                const response = await fetch('/admin/proxy-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': config.adminKey
                    },
                    body: JSON.stringify({
                        enabled: config.enableProxy,
                        baseUrl: config.proxyUrl,
                        fallbackToDirect: config.fallbackDirect
                    })
                });
                
                if (response.ok) {
                    showResult('ä¸­è½¬æœåŠ¡é…ç½®å·²æ›´æ–°', 'success');
                } else {
                    showResult('ä¸­è½¬æœåŠ¡é…ç½®æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                showResult('æ›´æ–°ä¸­è½¬æœåŠ¡é…ç½®æ—¶å‡ºé”™: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•å‡½æ•°
        async function testHealth() {
            const config = getConfig();
            showResult('æ­£åœ¨æµ‹è¯•å¥åº·æ£€æŸ¥...', 'info');
            
            const response = await makeRequest(`${config.serviceUrl}/health`);
            
            if (response.status === 200) {
                showResult('âœ… å¥åº·æ£€æŸ¥é€šè¿‡', 'success', response.data);
            } else {
                showResult('âŒ å¥åº·æ£€æŸ¥å¤±è´¥', 'error', response.data);
            }
        }

        async function testAddKey() {
            const config = getConfig();
            if (!config.adminKey || !config.geminiApiKey) {
                showResult('âŒ è¯·å…ˆé…ç½®ç®¡ç†å‘˜å¯†é’¥å’ŒGemini APIå¯†é’¥', 'error');
                return;
            }
            
            showResult('æ­£åœ¨æ·»åŠ APIå¯†é’¥...', 'info');
            
            const response = await makeRequest(`${config.serviceUrl}/admin/keys`, {
                method: 'POST',
                headers: {
                    'X-Admin-Key': config.adminKey
                },
                body: JSON.stringify({
                    provider: 'gemini',
                    apiKey: config.geminiApiKey,
                    maxRequests: 1000,
                    metadata: {
                        description: 'Test Gemini API Key',
                        tags: ['test', 'gemini']
                    }
                })
            });
            
            if (response.status === 201) {
                showResult('âœ… å¯†é’¥æ·»åŠ æˆåŠŸ', 'success', response.data);
            } else {
                showResult('âŒ å¯†é’¥æ·»åŠ å¤±è´¥', 'error', response.data);
            }
        }

        async function testGetStatus() {
            const config = getConfig();
            if (!config.adminKey) {
                showResult('âŒ è¯·å…ˆé…ç½®ç®¡ç†å‘˜å¯†é’¥', 'error');
                return;
            }
            
            showResult('æ­£åœ¨è·å–å¯†é’¥æ± çŠ¶æ€...', 'info');
            
            const response = await makeRequest(
                `${config.serviceUrl}/admin/status?provider=gemini`,
                {
                    method: 'GET',
                    headers: {
                        'X-Admin-Key': config.adminKey
                    }
                }
            );
            
            if (response.status === 200) {
                showResult('âœ… çŠ¶æ€è·å–æˆåŠŸ', 'success', response.data);
            } else {
                showResult('âŒ çŠ¶æ€è·å–å¤±è´¥', 'error', response.data);
            }
        }

        async function testGeminiAPI() {
            const config = getConfig();
            showResult('æ­£åœ¨æµ‹è¯•Gemini APIè°ƒç”¨...', 'info');
            
            const response = await makeRequest(
                `${config.serviceUrl}/api/gemini/models/gemini-pro:generateContent?strategy=roundRobin`,
                {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: "Hello! Please respond with 'API Key Pool Service is working!' in English."
                                    }
                                ]
                            }
                        ]
                    })
                }
            );
            
            if (response.status === 200 && response.data.candidates) {
                const responseText = response.data.candidates[0]?.content?.parts[0]?.text || 'No response';
                showResult('âœ… Gemini APIè°ƒç”¨æˆåŠŸ', 'success', {
                    response: responseText.substring(0, 100) + '...'
                });
            } else {
                showResult('âŒ Gemini APIè°ƒç”¨å¤±è´¥', 'error', response.data);
            }
        }

        async function runFullTest() {
            showResult('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...', 'info');
            
            await testHealth();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAddKey();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testGetStatus();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testGeminiAPI();
            
            showResult('ğŸ‰ å®Œæ•´æµ‹è¯•å®Œæˆ!', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½é…ç½®
        window.onload = function() {
            loadConfig();
        };
    </script>
</body>
</html> 